<?php
/*
 * Copyright (c) 2017-2025 Aimy Extensions, Netzum Sorglos Software GmbH
 * Copyright (c) 2013-2017 Aimy Extensions, Lingua-Systems Software GmbH
 *
 * https://www.aimy-extensions.com/
 *
 * License: GNU GPLv2, see LICENSE.txt within distribution and/or
 *          http://www.aimy-extensions.com/software-license.html
 */
 defined( '_JEXEC' ) or die(); use Joomla\CMS\Plugin\CMSPlugin; use Joomla\CMS\Factory; use Joomla\CMS\Uri\Uri; use Joomla\CMS\Router\Router; use Joomla\CMS\Router\Route; use Joomla\CMS\HTML\HTMLHelper; class plgSystemAimyCanonical extends CMSPlugin { private $noindex = false; private $href = null; function onBeforeCompileHead() { $sef_on = self::get_joomla_config( 'sef', false ); $domain = $this->params->get( 'domain', isset( $_SERVER[ 'HTTP_HOST' ] ) ? $_SERVER[ 'HTTP_HOST' ] : '' ); $proto = $this->params->get( 'protocol', null ); $app = Factory::getApplication(); $doc = Factory::getDocument(); if ( ! self::in_frontend() or $doc->getType() != 'html' ) { return; } if ( empty( $domain ) ) { return; } if ( intVal( Factory::getUser()->id ) > 0 ) { $doc->addCustomTag( '<!-- Aimy Canonical: canonical link tag omitted ' . 'as you are logged in -->' ); return; } if ( $robots = $doc->getMetaData( 'robots' ) ) { if ( stripos( $robots, 'noindex' ) !== false ) { $this->noindex = true; } } $ctx_option = $app->input->getCmd( 'option', '' ); $ctx_view = $app->input->getCmd( 'view', '' ); $ctx = $ctx_option . '.' . $ctx_view; if ( $ctx == 'com_sppagebuilder.form' ) { return; } $c_url = null; foreach ( $doc->_links as $url => $attr ) { if ( $attr[ 'relation' ] === 'canonical' ) { $c_url = $url; unset( $doc->_links[ $url ] ); } } $cur_url = Uri::getInstance()->toString(); $uri = new Uri( empty( $c_url ) ? $cur_url : $c_url ); $uri->setHost( self::fix_domain_input( $domain ) ); if ( ! empty( $proto ) ) { $uri->setScheme( $proto ); } if ( strVal( $uri->getQuery() ) == "" && ! empty( $_SERVER[ 'QUERY_STRING' ] ) ) { $uri->setQuery( $_SERVER[ 'QUERY_STRING' ] ); } if ( strpos( $uri->getPath(), '/' ) !== 0 ) { $uri->setPath( '/' . $uri->getPath() ); } if ( $sef_on && $this->params->get( 'remove_query_string', false ) ) { $uri->setQuery( '' ); } $url = self::juri_to_url_obj( $uri ); if ( ! empty( $url->query ) ) { parse_str( $url->query, $qparts ); $qs = http_build_query( $qparts ); $url->query = $qs; } if ( ! $this->noindex ) { $this->href = self::url_obj_to_string( $url, true ); } } public function onAfterRender() { if ( empty( $this->href ) ) { return; } if ( $this->noindex ) { return; } $app = Factory::getApplication(); if ( ! self::in_frontend() ) { return; } $doc = Factory::getDocument(); if ( $doc->getType() !== 'html' ) { return; } $html = $app->getBody(); if ( ! is_string( $html ) or empty( $html ) ) { return false; } $can_link = sprintf( '<link rel="canonical" href="%s" />', htmlspecialchars( $this->href, ENT_COMPAT, 'UTF-8', false ) ); if ( preg_match( '#(<head[^>]*>)(.*?)(</head\s*>)#si', $html, $m ) ) { $h = $m[ 2 ]; if ( ! $this->noindex ) { $html = str_replace( $m[0], sprintf( "%s\n%s\n%s\n%s\n", trim( $m[1] ), trim( $h ), $can_link, trim( $m[3] ) ), $html ); } else { } $app->setBody( $html ); } } static private function fix_domain_input( $domain ) { return preg_replace( '/\/.*$/', '', preg_replace( '/^[^\/]*?:\/\/+/', '', trim( $domain ) ) ); } static private function get_joomla_config( $key, $dflt = null ) { $app = Factory::getApplication(); if ( version_compare( JVERSION, '3.3.0', '<' ) ) { return $app->getCfg( $key, $dflt ); } else { return $app->get( $key, $dflt ); } } static private function in_frontend() { $app = Factory::getApplication(); if ( strpos( strVal( JVERSION ), '3.' ) === 0 ) { return $app->isSite(); } return $app->isClient( 'site' ); } static private function encode_path( $p ) { $p = str_replace( ' ', '%20', $p ); $ps = str_split( $p ); $res = ''; foreach ( $ps as $c ) { $res .= ( ord( $c ) > 0x7f ? urlencode( $c ) : $c ); } return $res; } static private function url_obj_to_string( $uo, $encode = false ) { $s = $uo->scheme . '://' . $uo->host; if ( ! empty( $uo->port ) ) { $s .= ':' . $uo->port; } $s .= $encode ? self::encode_path( $uo->path ) : $uo->path; if ( ! empty( $uo->query ) ) { $s .= '?' . $uo->query; } return $s; } static private function juri_to_url_obj( $juri ) { $url = new StdClass(); $url->scheme = $juri->getScheme(); $url->host = $juri->getHost(); $url->port = $juri->getPort(); $url->path = $juri->getPath(); $url->query = $juri->getQuery(); return $url; } } 
